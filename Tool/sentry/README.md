## Sentry

Sentry是一套用于捕获产品错误的开源项目，其下支持很多语言、框架。

在JavaScript中是有window.onerror这个方法的，而Sentry在前端的核心捕获原理，就是通过重写此方法，来对所有的错误进行捕获。
同时会把平台的一些信息例如：user-agent、浏览器信息、系统信息、自定义信息等信息交给Sentry服务端，进行错误信息展示。

window.onerror无法捕捉Promise的错误，但是可以这样捕获
window.addEventListener('unhandledrejection', event => {})

### 个人总结

- 错误交给第三方库TraceKit来处理
- 针对不同浏览器做兼容处理（computeStackTrace）
- computeStackTrace会对错误信息进行格式，统一数据格式
- 发起请求上报数据

其中支持的信息类型重点分为以下几种：

- sentry基本配置信息，包括库本身的配置和使用者的配置信息，以及用户的一些自定义信息
- 错误信息，主要包括错误调用栈信息
- request 信息，主要包括浏览器的 User-Agent、当前请求地址等
- 面包屑信息

报文格式预览
```js
{
    "extra":{
        "__serialized__":{
            "code":300400,
            "message":"该渠道暂不支持换卡"
        },
        "arguments":[

        ]
    },
    "message":"Non-Error exception captured with keys: code, message",
    "stacktrace":{
        "frames":[
            {
                "colno":29,
                "filename":"http://localhost:4200/polyfills.js",
                "function":"timer",
                "in_app":true,
                "lineno":9812
            },
            {
                "colno":48,
                "filename":"http://localhost:4200/polyfills.js",
                "function":"ZoneTask.invoke",
                "in_app":true,
                "lineno":8018
            },
            {
                "colno":34,
                "filename":"http://localhost:4200/polyfills.js",
                "function":"push../node_modules/zone.js/dist/zone.js.ZoneTask.invokeTask",
                "in_app":true,
                "lineno":8029
            },
            {
                "colno":47,
                "filename":"http://localhost:4200/polyfills.js",
                "function":"Zone.push../node_modules/zone.js/dist/zone.js.Zone.runTask",
                "in_app":true,
                "lineno":7726
            },
            {
                "colno":60,
                "filename":"http://localhost:4200/polyfills.js",
                "function":"ZoneDelegate.push../node_modules/zone.js/dist/zone.js.ZoneDelegate.invokeTask",
                "in_app":true,
                "lineno":7953
            },
            {
                "colno":33,
                "filename":"http://localhost:4200/vendor.js",
                "function":"Object.onInvokeTask",
                "in_app":true,
                "lineno":53486
            },
            {
                "colno":31,
                "filename":"http://localhost:4200/polyfills.js",
                "function":"ZoneDelegate.push../node_modules/zone.js/dist/zone.js.ZoneDelegate.invokeTask",
                "in_app":true,
                "lineno":7954
            },
            {
                "colno":75,
                "filename":"http://localhost:4200/vendor.js",
                "function":"sentryWrapped",
                "in_app":true,
                "lineno":89655
            },
            {
                "colno":5,
                "filename":"http://localhost:4200/vendor.js",
                "function":"withScope",
                "in_app":true,
                "lineno":94363
            },
            {
                "colno":28,
                "filename":"http://localhost:4200/vendor.js",
                "function":"callOnHub",
                "in_app":true,
                "lineno":94233
            },
            {
                "colno":13,
                "filename":"http://localhost:4200/vendor.js",
                "function":"Hub.push../node_modules/@sentry/hub/esm/hub.js.Hub.withScope",
                "in_app":true,
                "lineno":93406
            },
            {
                "colno":86,
                "filename":"http://localhost:4200/vendor.js",
                "function":"?",
                "in_app":true,
                "lineno":89664
            }
        ]
    },
    "exception":{
        "values":[
            {
                "value":"Custom Object",
                "type":"Error",
                "mechanism":{
                    "handled":true,
                    "synthetic":true,
                    "type":"generic"
                }
            }
        ]
    },
    "level":"error",
    "event_id":"b29eee6461c842b3a7d137e8a5a8f51b",
    "platform":"javascript",
    "sdk":{
        "name":"sentry.javascript.browser",
        "packages":[
            {
                "name":"npm:@sentry/browser",
                "version":"5.5.0"
            }
        ],
        "version":"5.5.0",
        "integrations":[
            "InboundFilters",
            "FunctionToString",
            "TryCatch",
            "Breadcrumbs",
            "GlobalHandlers",
            "LinkedErrors",
            "UserAgent"
        ]
    },
    "environment":"local",
    "release":"19730",
    "breadcrumbs":[
        {
            "timestamp":1567154961.969,
            "category":"ui.click",
            "message":"ion-content.ios.overscroll > ion-item.mx-2"
        },
        {
            "timestamp":1567154962.065,
            "category":"fetch",
            "data":{
                "method":"GET",
                "url":"/svg/ios-close-circle-outline.svg",
                "status_code":200
            },
            "type":"http"
        },
        {
            "timestamp":1567154962.067,
            "category":"fetch",
            "data":{
                "method":"GET",
                "url":"/svg/ios-arrow-forward.svg",
                "status_code":200
            },
            "type":"http"
        },
        {
            "timestamp":1567154962.082,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "Angular is running in the development mode. Call enableProdMode() to enable the production mode."
                    ]
                },
                "logger":"console"
            },
            "level":"log",
            "message":"Angular is running in the development mode. Call enableProdMode() to enable the production mode."
        },
        {
            "timestamp":1567154962.103,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "System:",
                        "iPhone, iOS 11.0"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] System: iPhone, iOS 11.0"
        },
        {
            "timestamp":1567154962.105,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "Protocol:",
                        "HTTP"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] Protocol: HTTP"
        },
        {
            "timestamp":1567154962.106,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "UA:",
                        "Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] UA: Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1"
        },
        {
            "timestamp":1567154962.123,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "navigationStart:",
                        1567154960557
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] navigationStart: 1567154960557"
        },
        {
            "timestamp":1567154962.125,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "navigation:",
                        "2ms"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] navigation: 2ms"
        },
        {
            "timestamp":1567154962.127,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "dns:",
                        "0ms"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] dns: 0ms"
        },
        {
            "timestamp":1567154962.128,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "tcp:",
                        "0ms"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] tcp: 0ms"
        },
        {
            "timestamp":1567154962.13,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "request:",
                        "34ms"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] request: 34ms"
        },
        {
            "timestamp":1567154962.131,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "response:",
                        "1ms"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] response: 1ms"
        },
        {
            "timestamp":1567154962.132,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "domComplete (domLoaded):",
                        "1470ms (1071ms)"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] domComplete (domLoaded): 1470ms (1071ms)"
        },
        {
            "timestamp":1567154962.134,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "loadEvent:",
                        "44ms"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] loadEvent: 44ms"
        },
        {
            "timestamp":1567154962.135,
            "category":"console",
            "data":{
                "extra":{
                    "arguments":[
                        "[system]",
                        "total (DOM):",
                        "1561ms (1517ms)"
                    ]
                },
                "logger":"console"
            },
            "level":"info",
            "message":"[system] total (DOM): 1561ms (1517ms)"
        },
        {
            "timestamp":1567154962.136,
            "category":"ui.click",
            "message":"div#__vconsole > div.vc-panel > div.vc-toolbar > a.vc-tool.vc-tool-storage"
        },
        {
            "timestamp":1567154962.712,
            "category":"ui.click",
            "message":"ion-item.mx-2.item-label.item.ios.item-lines-none.ion-focusable.hydrated"
        },
        {
            "timestamp":1567154962.938,
            "category":"xhr",
            "data":{
                "method":"POST",
                "url":"/api/uranus/bind-card/changeCard/std",
                "status_code":200
            },
            "type":"http"
        },
        {
            "timestamp":1567154963.106,
            "category":"navigation",
            "data":{
                "from":"/#/uranus/repayment-recent",
                "to":"#/uranus/change-card?nonce=c393f5106f514897be3f91c1364bf798×tamp=1567154962868&signature=a6bcde56fcd37a1f86892149a6e75f6fdc86be77dbc8b3167ff726c4fc9aa892"
            }
        },
        {
            "timestamp":1567154963.17,
            "category":"ui.click",
            "message":"ion-button.ion-color.ion-color-primary.ios.button.button-small.button-clear.button-disabled.ion-activatable.ion-focusable.hydrated"
        },
        {
            "timestamp":1567154963.218,
            "category":"xhr",
            "data":{
                "method":"GET",
                "url":"/api/clear/uranus/repayment-recent",
                "status_code":204
            },
            "type":"http"
        },
        {
            "timestamp":1567154963.252,
            "category":"xhr",
            "data":{
                "method":"GET",
                "url":"/api/uranus/bind-card/with-token?nonce=c393f5106f514897be3f91c1364bf798×tamp=1567154962868&signature=a6bcde56fcd37a1f86892149a6e75f6fdc86be77dbc8b3167ff726c4fc9aa892",
                "status_code":200
            },
            "type":"http"
        },
        {
            "timestamp":1567154965.575,
            "category":"ui.click",
            "message":"ion-button.hydrated.activated.ion-color.ion-color-primary.ios.button.button-small.button-clear.button-disabled.ion-activatable.ion-focusable"
        },
        {
            "timestamp":1567154965.613,
            "category":"xhr",
            "data":{
                "method":"GET",
                "url":"/api/bankcards/621226",
                "status_code":200
            },
            "type":"http"
        },
        {
            "timestamp":1567154965.645,
            "category":"xhr",
            "data":{
                "method":"GET",
                "url":"/api/funds/QSI/banks",
                "status_code":200
            },
            "type":"http"
        },
        {
            "timestamp":1567154965.668,
            "category":"sentry",
            "event_id":"72458f7abefa4b82a972d76b16683908",
            "level":"debug",
            "message":"{"code":0}"
        },
        {
            "timestamp":1567154965.871,
            "category":"xhr",
            "data":{
                "method":"POST",
                "url":"/api/uranus/bind-card",
                "status_code":500
            },
            "type":"http"
        },
        {
            "timestamp":1567154965.879,
            "category":"sentry",
            "event_id":"028ae945d1004cc29a27ac55a15d252d",
            "level":"debug",
            "message":"{"code":300400,"message":"该渠道暂不支持换卡"}"
        },
        {
            "timestamp":1567154965.882,
            "category":"sentry",
            "event_id":"b1312b126a9544ed917a546d4a6f6ffe",
            "level":"debug",
            "message":"{"code":300400,"message":"该渠道暂不支持换卡"}"
        }
    ],
    "request":{
        "url":"http://localhost:4200/#/uranus/change-card?nonce=c393f5106f514897be3f91c1364bf798×tamp=1567154962868&signature=a6bcde56fcd37a1f86892149a6e75f6fdc86be77dbc8b3167ff726c4fc9aa892",
        "headers":{
            "User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1"
        }
    }
}
```